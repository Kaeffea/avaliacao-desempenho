<div class="spinner-overlay" *ngIf="mutating">
  <div class="spinner-ring"></div>
  <span>Aguardando resposta da API...</span>
</div>

<div class="page-wrapper">
  <app-alert #alertRef [message]="alertMessage" [type]="alertType" [autoDismiss]="true" />
  <div class="page-header">
    <div class="logo-mark">
      <i class="bi bi-bar-chart-line-fill"></i>
    </div>
    <h1>LCCV — Avaliações de Desempenho</h1>
  </div>

  <div class="main-card">
    <div class="card-head">
      <h5>Avaliações de desempenho</h5>
      <button
        class="btn-add"
        data-bs-toggle="modal"
        data-bs-target="#cadastrarModal"
        [disabled]="!formData"
        title="Nova avaliação"
      >
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>

    <div *ngIf="loading" class="empty-state">
      <div class="spinner-border spinner-border-sm text-secondary mb-2"></div>
      <div>Carregando...</div>
    </div>

    <div *ngIf="!loading && apiError" class="empty-state">
      <i class="bi bi-wifi-off d-block fs-2 mb-2"></i>
      <p class="mb-2">Não foi possível conectar à API.</p>
      <button class="btn btn-sm btn-outline-secondary" (click)="loadAvaliacoes()">
        <i class="bi bi-arrow-clockwise"></i> Tentar novamente
      </button>
    </div>

    <table *ngIf="!loading && !apiError" class="data-table">
      <thead>
        <tr>
          <th class="col-id">#</th>
          <th>Colaborador</th>
          <th>Competência</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let avaliacao of avaliacoes; let i = index">
          <td class="col-id">{{ i + 1 }}</td>
          <td>{{ avaliacao.nome_colaborador }}</td>
          <td>{{ avaliacao.competencia }}</td>
          <td>
            <app-status-badge [status]="avaliacao.status.descricao" />
          </td>
          <td>
            <div class="d-flex gap-1">
              <a
                [routerLink]="['/avaliacoes', avaliacao.id_avaliacao]"
                class="action-btn action-view"
                title="Visualizar"
              >
                <i class="bi bi-eye"></i>
              </a>
              <button
                class="action-btn action-play"
                title="Iniciar"
                [disabled]="avaliacao.status.id !== 1"
                (click)="onIniciar(avaliacao.id_avaliacao)"
              >
                <i class="bi bi-play-fill"></i>
              </button>
              <a
                *ngIf="avaliacao.status.id === 2 || avaliacao.status.id === 3"
                [routerLink]="['/avaliacoes', avaliacao.id_avaliacao, 'editar']"
                class="action-btn action-edit"
                title="Editar"
              >
                <i class="bi bi-pencil-square"></i>
              </a>
              <button
                *ngIf="avaliacao.status.id !== 2 && avaliacao.status.id !== 3"
                class="action-btn action-edit"
                disabled
                title="Editar"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button
                class="action-btn action-feedback"
                title="Dar feedback"
                [disabled]="avaliacao.status.id !== 2"
                (click)="onDarFeedback(avaliacao.id_avaliacao)"
              >
                <i class="bi bi-mic"></i>
              </button>
              <button
                class="action-btn action-conclude"
                title="Concluir"
                [disabled]="avaliacao.status.id !== 3"
                (click)="onConcluir(avaliacao.id_avaliacao)"
              >
                <i class="bi bi-check-square"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="avaliacoes.length === 0">
          <td colspan="5">
            <div class="empty-state">Nenhuma avaliação encontrada.</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<app-cadastrar-avaliacao-modal
  *ngIf="formData"
  [formData]="formData"
  (cadastrar)="onCadastrar($event)"
/>